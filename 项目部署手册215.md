# 项目部署手册

## 目录

1. [系统环境准备](#1-系统环境准备)
2. [获取项目代码](#2-获取项目代码)
3. [配置文件](#3-配置文件)
   - [3.1 `wp-config.php`](#31-wp-configphp)
   - [3.2 `nginx.conf`](#32-nginxconf)
   - [3.3 `docker-compose.yml`](#33-docker-composeyml)
4. [构建和启动容器](#4-构建和启动容器)
5. [初始化数据库](#5-初始化数据库)
6. [配置并安装WordPress Multisite](#6-配置并安装wordpress-multisite)
7. [服务拆分与微服务化](#7-服务拆分与微服务化)
   - [7.1 用户服务](#71-用户服务)
   - [7.2 文章服务](#72-文章服务)
8. [配置负载均衡和服务发现](#8-配置负载均衡和服务发现)
9. [日志和监控](#9-日志和监控)
10. [持续集成和持续部署（CI/CD）](#10-持续集成和持续部署cicd)
11. [安全配置](#11-安全配置)
12. [数据库一致性解决方案](#12-数据库一致性解决方案)
   - [12.1 实现Saga模式](#121-实现saga模式)
   - [12.2 数据一致性校验](#122-数据一致性校验)
13. [数据迁移](#13-数据迁移)
   - [13.1 使用Flyway进行数据迁移](#131-使用flyway进行数据迁移)
   - [13.2 使用Liquibase进行数据迁移](#132-使用liquibase进行数据迁移)
14. [API文档和示例代码](#14-api文档和示例代码)
   - [14.1 用户API](#141-用户api)
   - [14.2 文章API](#142-文章api)
15. [自动化测试用例和脚本](#15-自动化测试用例和脚本)
   - [15.1 使用PHPUnit进行单元测试](#151-使用phpunit进行单元测试)
   - [15.2 使用Jest进行JavaScript测试](#152-使用jest进行javascript测试)
16. [API网关设计和配置](#16-api网关设计和配置)
   - [16.1 使用Nginx作为API网关](#161-使用nginx作为api网关)
17. [多租户支持](#17-多租户支持)
   - [17.1 租户ID映射实现](#171-租户id映射实现)
   - [17.2 租户注册自动化工具](#172-租户注册自动化工具)
18. [插件开发规范和示例代码](#18-插件开发规范和示例代码)
   - [18.1 插件开发规范](#181-插件开发规范)
   - [18.2 插件示例代码](#182-插件示例代码)
19. [监控和报警配置](#19-监控和报警配置)
   - [19.1 配置Prometheus](#191-配置prometheus)
     - [19.1.1 `prometheus.yml`配置文件](#1911-prometheusyml配置文件)
     - [19.1.2 `docker-compose.yml`新增Prometheus服务](#1912-docker-composeyml新增prometheus服务)
   - [19.2 配置Grafana](#192-配置grafana)
     - [19.2.1 `docker-compose.yml`新增Grafana服务](#1921-docker-composeyml新增grafana服务)
   - [19.3 配置报警规则](#193-配置报警规则)
     - [19.3.1 `alertmanager.yml`配置文件](#1931-alertmanageryml配置文件)
     - [19.3.2 `docker-compose.yml`新增Alertmanager服务](#1932-docker-composeyml新增alertmanager服务)
20. [安全性措施](#20-安全性措施)
   - [20.1 API认证与授权](#201-api认证与授权)
   - [20.2 数据加密](#202-数据加密)
   - [20.3 DDoS防护](#203-ddos防护)

## 1. 系统环境准备

安装Docker、Git、Node.js和npm：

```bash
sudo apt-get update
sudo apt-get install -y docker.io git nodejs npm
```

## 2. 获取项目代码

克隆项目代码：

```bash
git clone https://github.com/your-repo/project.git
cd project
```

## 3. 配置文件

### 3.1 `wp-config.php`

```php name=src/wp-config.php
<?php
define('DB_NAME', 'wordpress');
define('DB_USER', 'root');
define('DB_PASSWORD', 'root');
define('DB_HOST', 'db');
define('DB_CHARSET', 'utf8');
define('DB_COLLATE', '');
$table_prefix = 'wp_';
define('WP_DEBUG', false);
if (!defined('ABSPATH')) {
    define('ABSPATH', dirname(__FILE__) . '/');
}
require_once(ABSPATH . 'wp-settings.php');
```

### 3.2 `nginx.conf`

```plaintext name=nginx.conf
server {
    listen 80;
    server_name example.com;
    root /var/www/html;

    index index.php index.html index.htm;

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
    }

    location ~ /\.ht {
        deny all;
    }
}
```

### 3.3 `docker-compose.yml`

```yaml name=docker-compose.yml
version: '3.8'

services:
  wordpress:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "80:80"
    volumes:
      - ./src:/var/www/html
      - ./nginx.conf:/etc/nginx/nginx.conf
    environment:
      WORDPRESS_DB_HOST: db
      WORDPRESS_DB_USER: root
      WORDPRESS_DB_PASSWORD: root
      WORDPRESS_DB_NAME: wordpress

  db:
    image: mysql:5.7
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: wordpress
    volumes:
      - db_data:/var/lib/mysql

  traefik:
    image: traefik:v2.4
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "./traefik/traefik.toml:/traefik.toml"

volumes:
  db_data:
```

## 4. 构建和启动容器

通过命令行构建和启动Docker容器：

```bash
docker-compose up --build
```

## 5. 初始化数据库

通过命令行和SQL命令初始化数据库：

```bash
docker exec -it <db_container_id> mysql -u root -p
CREATE DATABASE wordpress;
GRANT ALL PRIVILEGES ON wordpress.* TO 'root'@'%' IDENTIFIED BY 'root';
FLUSH PRIVILEGES;
EXIT;
```

## 6. 配置并安装WordPress Multisite

编辑配置文件并按照提示完成安装过程：

```php name=src/wp-config.php
define('WP_ALLOW_MULTISITE', true);
```

访问WordPress后台，完成网络安装。

## 7. 服务拆分与微服务化

### 7.1 用户服务

创建`user-service`文件夹，并编写用户服务代码。

```javascript name=user-service/index.js
const express = require('express');
const app = express();
const port = 3001;

app.use(express.json());

let users = [
    { id: 1, name: 'John Doe', email: 'john.doe@example.com' },
    { id: 2, name: 'Jane Smith', email: 'jane.smith@example.com' }
];

app.get('/users', (req, res) => {
    res.json(users);
});

app.listen(port, () => {
    console.log(`User service running on port ${port}`);
});
```

创建`user-service/Dockerfile`文件。

```dockerfile name=user-service/Dockerfile
FROM node:14

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .

EXPOSE 3001
CMD [ "node", "index.js" ]
```

### 7.2 文章服务

创建`post-service`文件夹，并编写文章服务代码。

```javascript name=post-service/index.js
const express = require('express');
const app = express();
const port = 3002;

app.use(express.json());

let posts = [
    { id: 1, title: 'First Post', content: 'This is the first post.', author_id: 1 },
    { id: 2, title: 'Second Post', content: 'This is the second post.', author_id: 1 }
];

app.get('/posts', (req, res) => {
    res.json(posts);
});

app.listen(port, () => {
    console.log(`Post service running on port ${port}`);
});
```

创建`post-service/Dockerfile`文件。

```dockerfile name=post-service/Dockerfile
FROM node:14

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .

EXPOSE 3002
CMD [ "node", "index.js" ]
```

## 8. 配置负载均衡和服务发现

配置Traefik和Nginx的配置文件，不需要编写新的功能代码。

## 9. 日志和监控

配置ELK Stack和Prometheus的配置文件，不需要编写新的功能代码。

## 10. 持续集成和持续部署（CI/CD）

配置GitHub Actions的配置文件，不需要编写新的功能代码。

## 11. 安全配置

配置SSL证书、防火墙和访问控制的配置文件，不需要编写新的功能代码。

## 12. 数据库一致性解决方案

### 12.1 实现Saga模式

编写Saga协调器代码文件。

```typescript name=saga-coordinator.ts
class SagaCoordinator {
    constructor(private steps: SagaStep[]) {}

    async execute(sagaContext: any) {
        const executedSteps = [];
        try {
            for (const step of this.steps) {
                await step.execute(sagaContext);
                executedSteps.push(step);
            }
        } catch (error) {
            await this.compensate(executedSteps, sagaContext);
            throw error;
        }
    }

    private async compensate(executedSteps: SagaStep[], sagaContext: any) {
        for (const step of executedSteps.reverse()) {
            await step.compensate(sagaContext);
        }
    }
}

interface SagaStep {
    execute(context: any): Promise<void>;
    compensate(context: any): Promise<void>;
}
```

### 12.2 数据一致性校验

编写数据一致性校验逻辑的代码文件。

```typescript name=data-consistency-checker.ts
class DataConsistencyChecker {
    constructor(private services: DataService[]) {}

    async check() {
        for (const service of this.services) {
            const isConsistent = await service.checkConsistency();
            if (!isConsistent) {
                await this.handleInconsistency(service);
            }
        }
    }

    private async handleInconsistency(service: DataService) {
        // 处理数据不一致的逻辑
    }
}

interface DataService {
    checkConsistency(): Promise<boolean>;
}
```

## 13. 数据迁移

### 13.1 使用Flyway进行数据迁移

编写迁移脚本文件。

```sql name=sql/V1__init.sql
CREATE TABLE example (
    id INT PRIMARY KEY,
    name VARCHAR(255) NOT NULL
);
```

### 13.2 使用Liquibase进行数据迁移

编写迁移脚本文件。

```xml name=db/changelog/db.changelog-master.xml
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet id="1" author="yourname">
        <createTable tableName="example">
            <column name="id" type="int">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

</databaseChangeLog>
```

## 14. API文档和示例代码

### 14.1 用户API

编写用户API示例代码文件。

```javascript name=api/user.js
const express = require('express');
const router = express.Router();

// 获取所有用户
router.get('/users', (req, res) => {
    // 示例数据
    const users = [
        { id: 1, name: 'John Doe', email: 'john.doe@example.com' },
        { id: 2, name: 'Jane Smith', email: 'jane.smith@example.com' }
    ];
    res.json(users);
});

// 获取单个用户
router.get('/users/:id', (req, res) => {
    const userId = parseInt(req.params.id, 10);
    // 示例数据
    const user = { id: userId, name: 'John Doe', email: 'john.doe@example.com' };
    res.json(user);
});

module.exports = router;
```

### 14.2 文章API

编写文章API示例代码文件。

```javascript name=api/post.js
const express = require('express');
const router = express.Router();

// 获取所有文章
router.get('/posts', (req, res) => {
    // 示例数据
    const posts = [
        { id: 1, title: 'First Post', content: 'This is the first post.', author_id: 1 },
        { id: 2, title: 'Second Post', content: 'This is the second post.', author_id: 1 }
    ];
    res.json(posts);
});

// 获取单个文章
router.get('/posts/:id', (req, res) => {
    const postId = parseInt(req.params.id, 10);
    // 示例数据
    const post = { id: postId, title: 'First Post', content: 'This is the first post.', author_id: 1 };
    res.json(post);
});

module.exports = router;
```

## 15. 自动化测试用例和脚本

### 15.1 使用PHPUnit进行单元测试

编写测试用例文件。

```php name=tests/ExampleTest.php
<?php

use PHPUnit\Framework\TestCase;

class ExampleTest extends TestCase
{
    public function testExample()
    {
        $this->assertTrue(true);
    }
}
```

### 15.2 使用Jest进行JavaScript测试

编写测试用例文件。

```javascript name=tests/example.test.js
const request = require('supertest');
const app = require('../app'); // 假设你的Express应用在app.js中

describe('GET /users', () => {
    it('should return all users', async () => {
        const response = await request(app).get('/users');
        expect(response.status).toBe(200);
        expect(response.body).toEqual([
            { id: 1, name: 'John Doe', email: 'john.doe@example.com' },
            { id: 2, name: 'Jane Smith', email: 'jane.smith@example.com' }
        ]);
    });
});
```

## 16. API网关设计和配置

### 16.1 使用Nginx作为API网关

配置Nginx作为API网关，将请求路由到不同的服务。

```plaintext name=nginx.conf
http {
    upstream user_service {
        server user-service:3001;
    }

    upstream post_service {
        server post-service:3002;
    }

    server {
        listen 80;
        server_name api.example.com;

        location /users {
            proxy_pass http://user_service;
        }

        location /posts {
            proxy_pass http://post_service;
        }
    }
}
```

## 17. 多租户支持

### 17.1 租户ID映射实现

实现租户ID映射逻辑，根据请求的域名或路径确定当前租户ID。

```php name=src/wp-config.php
<?php
// 获取当前请求的域名或路径，以确定租户ID
$host = $_SERVER['HTTP_HOST'];
$tenantId = getTenantIdByHost($host);

// 动态获取租户ID的函数
function getTenantIdByHost($host) {
    // 实现域名到租户ID的映射逻辑
    // 例如，可以查询数据库或配置文件进行映射
    // 这里假设存在一个简单的映射数组
    $tenantMapping = [
        'tenant1.example.com' => 'tenant1',
        'tenant2.example.com' => 'tenant2',
        // 添加其他租户映射
    ];

    return isset($tenantMapping[$host]) ? $tenantMapping[$host] : null;
}
```

### 17.2 租户注册自动化工具

实现租户注册自动化工具，简化新租户的添加过程。

```php name=src/register_tenant.php
<?php
// 获取新租户的域名和数据库配置
$newTenantHost = $_POST['host'];
$newTenantDbConfig = [
    'host' => $_POST['db_host'],
    'name' => $_POST['db_name'],
    'user' => $_POST['db_user'],
    'password' => $_POST['db_password']
];

// 将新租户的配置信息保存到数据库或配置文件
saveTenantConfig($newTenantHost, $newTenantDbConfig);

function saveTenantConfig($host, $dbConfig) {
    // 保存到配置文件示例
    $configFile = __DIR__ . '/config/database.php';
    $config = include($configFile);
    $config['tenants'][$host] = $dbConfig;
    file_put_contents($configFile, '<?php return ' . var_export($config, true) . ';');
    
    // 也可以选择保存到数据库
}
```

## 18. 插件开发规范和示例代码

### 18.1 插件开发规范

提供插件开发规范，确保插件的一致性和可维护性。

```markdown name=PLUGIN_GUIDELINES.md
# 插件开发规范

1. 命名规范
   - 插件名称应简洁明了，避免使用特殊字符。
   - 插件文件夹名称应与插件主文件名称一致。

2. 代码规范
   - 遵循PSR-12编码规范。
   - 使用命名空间避免命名冲突。

3. 功能实现
   - 插件应实现特定的功能，不应包含无关代码。
   - 插件应尽量避免对核心代码的修改。

4. 配置和文档
   - 插件应提供详细的配置说明和使用文档。
   - 插件应包含示例配置文件。
```

### 18.2 插件示例代码

提供插件示例代码，展示插件的基本结构和实现。

```php name=wp-content/plugins/example-plugin/example-plugin.php
<?php
/*
Plugin Name: Example Plugin
Description: This is an example plugin.
Version: 1.0
Author: Your Name
*/

if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly
}

// 插件的主要功能代码
function example_plugin_function() {
    echo 'Hello, this is an example plugin!';
}

add_action('wp_footer', 'example_plugin_function');
```

## 19. 监控和报警配置

### 19.1 配置Prometheus

在项目根目录下创建`prometheus`文件夹，并添加以下内容：

#### 19.1.1 `prometheus.yml`配置文件

```yml name=prometheus/prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  - job_name: 'user-service'
    static_configs:
      - targets: ['user-service:3001']

  - job_name: 'post-service'
    static_configs:
      - targets: ['post-service:3002']
```

#### 19.1.2 `docker-compose.yml`新增Prometheus服务

```yaml name=docker-compose.yml
version: '3.8'

services:
  wordpress:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "80:80"
    volumes:
      - ./src:/var/www/html
      - ./nginx.conf:/etc/nginx/nginx.conf
    environment:
      WORDPRESS_DB_HOST: db
      WORDPRESS_DB_USER: root
      WORDPRESS_DB_PASSWORD: root
      WORDPRESS_DB_NAME: wordpress

  db:
    image: mysql:5.7
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: wordpress
    volumes:
      - db_data:/var/lib/mysql

  user-service:
    build:
      context: ./user-service
    ports:
      - "3001:3001"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.user-service.rule=Host(`user.example.com`)"
      - "traefik.http.services.user-service.loadbalancer.server.port=3001"

  post-service:
    build:
      context: ./post-service
    ports:
      - "3002:3002"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.post-service.rule=Host(`post.example.com`)"
      - "traefik.http.services.post-service.loadbalancer.server.port=3002"

  traefik:
    image: traefik:v2.4
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "./traefik/traefik.toml:/traefik.toml"

  prometheus:
    image: prom/prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"

volumes:
  db_data:
```

### 19.2 配置Grafana

在项目根目录下创建`grafana`文件夹，并添加以下内容：

#### 19.2.1 `docker-compose.yml`新增Grafana服务

```yaml name=docker-compose.yml
version: '3.8'

services:
  wordpress:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "80:80"
    volumes:
      - ./src:/var/www/html
      - ./nginx.conf:/etc/nginx/nginx.conf
    environment:
      WORDPRESS_DB_HOST: db
      WORDPRESS_DB_USER: root
      WORDPRESS_DB_PASSWORD: root
      WORDPRESS_DB_NAME: wordpress

  db:
    image: mysql:5.7
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: wordpress
    volumes:
      - db_data:/var/lib/mysql

  user-service:
    build:
      context: ./user-service
    ports:
      - "3001:3001"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.user-service.rule=Host(`user.example.com`)"
      - "traefik.http.services.user-service.loadbalancer.server.port=3001"

  post-service:
    build:
      context: ./post-service
    ports:
      - "3002:3002"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.post-service.rule=Host(`post.example.com`)"
      - "traefik.http.services.post-service.loadbalancer.server.port=3002"

  traefik:
    image: traefik:v2.4
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "./traefik/traefik.toml:/traefik.toml"

  prometheus:
    image: prom/prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    ports:
      - "3000:3000"

volumes:
  db_data:
  esdata:
```

### 19.3 配置报警规则

在项目根目录下创建`alertmanager`文件夹，并添加以下内容：

#### 19.3.1 `alertmanager.yml`配置文件

```yml name=alertmanager/alertmanager.yml
global:
  resolve_timeout: 5m

route:
  receiver: 'default'

receivers:
  - name: 'default'
    email_configs:
      - to: 'your-email@example.com'
        from: 'alertmanager@example.com'
        smarthost: 'smtp.example.com:587'
        auth_username: 'your-username'
        auth_password: 'your-password'
```

#### 19.3.2 `docker-compose.yml`新增Alertmanager服务

```yaml name=docker-compose.yml
version: '3.8'

services:
  wordpress:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "80:80"
    volumes:
      - ./src:/var/www/html
      - ./nginx.conf:/etc/nginx/nginx.conf
    environment:
      WORDPRESS_DB_HOST: db
      WORDPRESS_DB_USER: root
      WORDPRESS_DB_PASSWORD: root
      WORDPRESS_DB_NAME: wordpress

  db:
    image: mysql:5.7
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: wordpress
    volumes:
      - db_data:/var/lib/mysql

  user-service:
    build:
      context: ./user-service
    ports:
      - "3001:3001"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.user-service.rule=Host(`user.example.com`)"
      - "traefik.http.services.user-service.loadbalancer.server.port=3001"

  post-service:
    build:
      context: ./post-service
    ports:
      - "3002:3002"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.post-service.rule=Host(`post.example.com`)"
      - "traefik.http.services.post-service.loadbalancer.server.port=3002"

  traefik:
    image: traefik:v2.4
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "./traefik/traefik.toml:/traefik.toml"

  prometheus:
    image: prom/prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    ports:
      - "3000:3000"

  alertmanager:
    image: prom/alertmanager
    volumes:
      - ./alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml
    ports:
      - "9093:9093"

volumes:
  db_data:
  esdata:
```

## 20. 安全性措施

### 20.1 API认证与授权

为API添加认证与授权机制，确保只有授权用户可以访问API。

```javascript name=api/auth.js
const jwt = require('jsonwebtoken');

// 验证JWT令牌的中间件
function authenticateToken(req, res, next) {
    const token = req.headers['authorization'];
    if (!token) return res.sendStatus(401);

    jwt.verify(token, process.env.ACCESS_TOKEN_SECRET, (err, user) => {
        if (err) return res.sendStatus(403);
        req.user = user;
        next();
    });
}

module.exports = authenticateToken;
```

### 20.2 数据加密

对敏感数据进行加密存储，确保数据在传输和存储过程中的安全性。

```javascript name=api/encryption.js
const crypto = require('crypto');

// 加密数据
function encrypt(text) {
    const cipher = crypto.createCipher('aes-256-cbc', process.env.ENCRYPTION_KEY);
    let encrypted = cipher.update(text, 'utf8', 'hex');
    encrypted += cipher.final('hex');
    return encrypted;
}

// 解密数据
function decrypt(text) {
    const decipher = crypto.createDecipher('aes-256-cbc', process.env.ENCRYPTION_KEY);
    let decrypted = decipher.update(text, 'hex', 'utf8');
    decrypted += decipher.final('utf8');
    return decrypted;
}

module.exports = { encrypt, decrypt };
```

### 20.3 DDoS防护

配置防火墙和限流策略，防止DDoS攻击。

```plaintext name=nginx.conf
http {
    ...

    limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s;

    server {
        ...

        location / {
            limit_req zone=one burst=5 nodelay;
            proxy_pass http://backend;
        }
    }
}
```
